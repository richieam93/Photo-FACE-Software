{% extends "base.html" %}

{% block title %}Suchergebnisse - Photo Software{% endblock %}

{% block extra_css %}
<style>
    /* ========================================
       SUCH-ERGEBNISSE STYLES
       ======================================== */
    
    .results-header {
        text-align: center;
        padding: 40px 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
        margin-bottom: 30px;
    }
    
    .results-header h1 {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .results-header .subtitle {
        color: #888888;
        font-size: 16px;
    }
    
    .search-summary {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .summary-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    .summary-icon {
        font-size: 24px;
    }
    
    /* Loading State */
    .loading-container {
        text-align: center;
        padding: 80px 20px;
    }
    
    .loading-container .spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 20px;
    }
    
    .loading-text {
        font-size: 18px;
        color: #888888;
    }
    
    /* Ergebnis Grid */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }
    
    .result-card {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        border-color: rgba(78, 205, 196, 0.3);
    }
    
    .result-card.top-match {
        border-color: #4ecdc4;
        box-shadow: 0 0 30px rgba(78, 205, 196, 0.2);
    }
    
    .result-image-container {
        position: relative;
        aspect-ratio: 4/3;
    }
    
    .result-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Match Score Badge */
    .match-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 16px;
    }
    
    .match-badge.excellent {
        background: linear-gradient(135deg, #51cf66, #40c057);
        color: #ffffff;
    }
    
    .match-badge.good {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
        color: #ffffff;
    }
    
    .match-badge.fair {
        background: linear-gradient(135deg, #fcc419, #fab005);
        color: #1a1a2e;
    }
    
    .match-badge.low {
        background: rgba(255, 255, 255, 0.2);
        color: #ffffff;
    }
    
    /* Top Match Indicator */
    .top-indicator {
        position: absolute;
        top: 15px;
        left: 15px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #ffd700, #ffaa00);
        color: #1a1a2e;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 700;
    }
    
    /* Result Info */
    .result-info {
        padding: 20px;
    }
    
    .result-filename {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 8px;
    }
    
    .result-time {
        font-size: 13px;
        color: #888888;
        margin-bottom: 15px;
    }
    
    /* Match Details */
    .match-details {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    .match-detail {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #aaaaaa;
    }
    
    .match-detail .value {
        color: #4ecdc4;
        font-weight: 600;
    }
    
    /* Color Preview */
    .color-preview {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    
    .color-preview-dot {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Result Actions */
    .result-actions {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .result-actions .btn {
        flex: 1;
        padding: 10px;
        font-size: 13px;
    }
    
    /* Empty/No Results */
    .no-results {
        text-align: center;
        padding: 80px 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
    }
    
    .no-results .icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .no-results h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .no-results p {
        color: #888888;
        margin-bottom: 20px;
    }
    
    /* ========================================
       DRUCK-MODAL
       ======================================== */
    
    .print-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .print-modal.active {
        display: flex;
    }
    
    .print-modal-content {
        background: #1a1a2e;
        border-radius: 25px;
        max-width: 600px;
        width: 100%;
        padding: 40px;
        animation: modalSlide 0.3s ease;
    }
    
    @keyframes modalSlide {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .print-modal-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .print-modal-header h2 {
        font-size: 28px;
        color: #ffffff;
        margin-bottom: 10px;
    }
    
    .print-preview {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .print-preview img {
        max-width: 400px;
        max-height: 300px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    /* Drucker-Auswahl */
    .printer-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .printer-option {
        background: rgba(255, 255, 255, 0.08);
        border: 3px solid transparent;
        border-radius: 20px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .printer-option:hover {
        border-color: rgba(78, 205, 196, 0.5);
        background: rgba(255, 255, 255, 0.12);
    }
    
    .printer-option.selected {
        border-color: #4ecdc4;
        background: rgba(78, 205, 196, 0.15);
    }
    
    .printer-option.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .printer-icon {
        font-size: 50px;
        margin-bottom: 15px;
    }
    
    .printer-name {
        font-size: 18px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 5px;
    }
    
    .printer-size {
        font-size: 14px;
        color: #888888;
        margin-bottom: 10px;
    }
    
    .printer-price {
        font-size: 24px;
        font-weight: 700;
        color: #4ecdc4;
    }
    
    /* Kopien */
    .copies-selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .copies-label {
        font-size: 16px;
        color: #aaaaaa;
    }
    
    .copies-control {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .copies-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #ffffff;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .copies-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .copies-value {
        font-size: 28px;
        font-weight: 700;
        color: #ffffff;
        min-width: 40px;
        text-align: center;
    }
    
    /* Total */
    .print-total {
        text-align: center;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        margin-bottom: 25px;
    }
    
    .total-label {
        font-size: 14px;
        color: #888888;
        margin-bottom: 5px;
    }
    
    .total-amount {
        font-size: 36px;
        font-weight: 700;
        color: #4ecdc4;
    }
    
    .total-currency {
        font-size: 18px;
        color: #888888;
    }
    
    /* Modal Actions */
    .print-modal-actions {
        display: flex;
        gap: 15px;
    }
    
    .print-modal-actions .btn {
        flex: 1;
        padding: 18px;
        font-size: 16px;
    }
    
    /* ========================================
       AUTO-REDIRECT TIMER
       ======================================== */

    .redirect-timer {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        padding: 20px;
        background: rgba(78, 205, 196, 0.1);
        border-radius: 15px;
        border: 2px solid rgba(78, 205, 196, 0.3);
    }

    .timer-display {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        color: #4ecdc4;
        font-weight: 600;
    }

    .timer-icon {
        font-size: 24px;
    }

    .redirect-timer .btn {
        padding: 10px 20px;
        font-size: 14px;
    }

    /* ========================================
       ANSICHT-MODAL
       ======================================== */

    .view-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1100;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .view-modal.active {
        display: flex;
    }

    .view-modal-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }

    .view-modal-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .view-modal-close {
        position: fixed;
        top: 20px;
        right: 30px;
        font-size: 50px;
        color: #ffffff;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s ease;
        z-index: 1101;
    }

    .view-modal-close:hover {
        opacity: 1;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .results-grid {
            grid-template-columns: 1fr;
        }

        .printer-options {
            grid-template-columns: 1fr;
        }

        .print-modal-content {
            padding: 25px;
        }

        .view-modal-image {
            max-width: 95vw;
            max-height: 95vh;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    
    <!-- Header -->
    <div class="results-header">
        <h1>üîç Suchergebnisse</h1>
        <p class="subtitle" id="results-subtitle">Suche wird durchgef√ºhrt...</p>

        <div class="search-summary" id="search-summary" style="display: none;">
            <div class="summary-item" id="summary-face" style="display: none;">
                <span class="summary-icon">üì∑</span>
                <span>Gesichtserkennung aktiv</span>
            </div>
            <div class="summary-item" id="summary-colors" style="display: none;">
                <span class="summary-icon">üé®</span>
                <span id="color-count">0 Farben ausgew√§hlt</span>
            </div>
        </div>

        <!-- Auto-Redirect Timer -->
        <div class="redirect-timer" id="redirect-timer" style="display: none;">
            <div class="timer-display">
                <span class="timer-icon">‚è∞</span>
                <span>Weiterleitung in <span id="countdown">30</span> Sekunden</span>
            </div>
            <button class="btn btn-secondary" onclick="redirectNow()">
                Sofort zur√ºck
            </button>
        </div>
    </div>
    
    <!-- Loading -->
    <div class="loading-container" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">Durchsuche Fotos...</p>
    </div>
    
    <!-- Ergebnisse -->
    <div class="results-grid" id="results-grid" style="display: none;"></div>
    
    <!-- Keine Ergebnisse -->
    <div class="no-results" id="no-results" style="display: none;">
        <div class="icon">üòï</div>
        <h2>Keine passenden Fotos gefunden</h2>
        <p>Versuche es mit anderen Suchkriterien oder w√§hle weniger Farben</p>
        <button class="btn btn-primary" onclick="goBack()">‚Üê Neue Suche</button>
    </div>
    
</div>

<!-- Ansicht-Modal -->
<div class="view-modal" id="view-modal" onclick="closeViewModalOnBackground(event)">
    <span class="view-modal-close" onclick="closeViewModal()">√ó</span>
    <div class="view-modal-content" onclick="event.stopPropagation()">
        <img class="view-modal-image" id="view-modal-image" src="" alt="">
    </div>
</div>

<!-- Druck-Modal -->
<div class="print-modal" id="print-modal" onclick="closePrintModalOnBackground(event)">
    <div class="print-modal-content" onclick="event.stopPropagation()">
        <div class="print-modal-header">
            <h2>üñ®Ô∏è Foto drucken</h2>
            <p style="color: #888;">W√§hle Gr√∂√üe und Anzahl</p>
        </div>

        <div class="print-preview">
            <img id="print-preview-img" src="" alt="Druckvorschau">
        </div>

        <div class="printer-options" id="printer-options">
            <!-- Wird dynamisch gef√ºllt -->
        </div>

        <div class="copies-selector">
            <span class="copies-label">Anzahl:</span>
            <div class="copies-control">
                <button class="copies-btn" onclick="changeCopies(-1)">‚àí</button>
                <span class="copies-value" id="copies-value">1</span>
                <button class="copies-btn" onclick="changeCopies(1)">+</button>
            </div>
        </div>

        <div class="print-total">
            <div class="total-label">Gesamtpreis</div>
            <div>
                <span class="total-currency">CHF</span>
                <span class="total-amount" id="total-amount">5.00</span>
            </div>
        </div>

        <div class="print-modal-actions">
            <button class="btn btn-secondary" onclick="closePrintModal()">Abbrechen</button>
            <button class="btn btn-success" onclick="confirmPrint()">‚úì Drucken</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========================================
    // VARIABLEN
    // ========================================

    let searchResults = [];
    let searchData = null;
    let displaySettings = {};

    let printImageId = null;
    let selectedPrinter = 'small';
    let copies = 1;
    let printerOptions = [];
    let isDirectPrint = false; // Track if opened directly for printing
    
    // ========================================
    // DISPLAY SETTINGS LADEN
    // ========================================

    console.log('Search results script loaded');

    async function loadDisplaySettings() {
        try {
            const response = await api('/admin/api/settings/default/display');
            if (response.success && response.settings) {
                displaySettings = response.settings;
            } else {
                displaySettings = { search_original: true };
            }
        } catch (error) {
            console.error('Fehler beim Laden der Display-Einstellungen:', error);
            displaySettings = { search_original: true };
        }
    }

    // ========================================
    // SUCHE DURCHF√úHREN
    // ========================================

    async function handlePrintParameter(imageId) {
        try {
            console.log('handlePrintParameter called with:', imageId);
            isDirectPrint = true; // Mark as direct print request
            // Seite f√ºr Druck vorbereiten
            document.getElementById('results-subtitle').textContent = 'Druckauftrag wird vorbereitet...';
            document.querySelector('.results-header h1').textContent = 'üñ®Ô∏è Foto drucken';

            // Druck-Modal √∂ffnen
            await openPrintModal(imageId);
        } catch (error) {
            console.error('Error in handlePrintParameter:', error);
            showToast('Fehler beim √ñffnen des Druck-Modals', 'error');
        }
    }

    async function performSearch() {
        // Pr√ºfen ob Druck-Parameter vorhanden
        const urlParams = new URLSearchParams(window.location.search);
        const printImageId = urlParams.get('print');

        if (printImageId) {
            // Direkt zum Druck-Modal f√ºr dieses Bild
            await handlePrintParameter(printImageId);
            return;
        }

        // Such-Daten aus Session holen
        const storedData = sessionStorage.getItem('searchData');

        if (!storedData) {
            showNoResults();
            document.getElementById('results-subtitle').textContent =
                'Keine Suchdaten gefunden. Bitte starte eine neue Suche.';
            return;
        }

        searchData = JSON.parse(storedData);
        updateSearchSummary();

        // Wenn Bild aus Karussell kommt, lade es zuerst
        if (searchData.imageId && !searchData.image) {
            try {
                const imageResponse = await fetch(searchData.imageUrl);
                const blob = await imageResponse.blob();
                const reader = new FileReader();
                searchData.image = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('Fehler beim Laden des Bildes aus Karussell:', error);
                showToast('Fehler beim Laden des Bildes', 'error');
                showNoResults();
                return;
            }
        }

        try {
            let endpoint = '/customer/api/search/';
            let body = {};

            if (searchData.mode === 'face') {
                endpoint += 'face';
                body = { image: searchData.image };
            } else if (searchData.mode === 'color') {
                endpoint += 'color';
                body = { colors: searchData.colors };
            } else {
                endpoint += 'combined';
                body = {
                    image: searchData.image,
                    colors: searchData.colors
                };
            }

            const response = await api(endpoint, {
                method: 'POST',
                body: JSON.stringify(body)
            });

            if (response.success && response.results && response.results.length > 0) {
                searchResults = response.results;
                renderResults();
            } else {
                showNoResults();
            }

        } catch (error) {
            console.error('Suchfehler:', error);
            showToast('Fehler bei der Suche', 'error');
            showNoResults();
        }
    }
    
    function updateSearchSummary() {
        const summary = document.getElementById('search-summary');
        summary.style.display = 'flex';
        
        if (searchData.image) {
            document.getElementById('summary-face').style.display = 'flex';
        }
        
        if (searchData.colors && searchData.colors.length > 0) {
            document.getElementById('summary-colors').style.display = 'flex';
            document.getElementById('color-count').textContent = 
                `${searchData.colors.length} Farben ausgew√§hlt`;
        }
    }
    
    // ========================================
    // ERGEBNISSE RENDERN
    // ========================================

    let redirectTimer = null;
    let redirectCountdown = 30;

    function renderResults() {
        document.getElementById('loading').style.display = 'none';

        const grid = document.getElementById('results-grid');
        grid.style.display = 'grid';

        document.getElementById('results-subtitle').textContent =
            `${searchResults.length} passende Fotos gefunden`;

        // Pr√ºfen ob Originalbilder aktiviert sind (Standard: true)
        const useOriginal = displaySettings.search_original !== false;

        grid.innerHTML = searchResults.map((result, index) => {
            const matchClass = getMatchClass(result.score);
            const isTop = index === 0 && result.score >= 70;
            const imageParam = useOriginal ? '?original=true' : '';

            return `
                <div class="result-card ${isTop ? 'top-match' : ''}">
                    <div class="result-image-container">
                        <img
                            class="result-image"
                            src="/customer/api/image/${result.image_id}/file${imageParam}"
                            alt="${result.filename}"
                            loading="lazy"
                        >
                        ${isTop ? '<div class="top-indicator">‚≠ê Beste √úbereinstimmung</div>' : ''}
                        <div class="match-badge ${matchClass}">${result.score.toFixed(0)}%</div>
                    </div>

                    <div class="result-info">
                        <div class="result-filename">${result.filename}</div>
                        <div class="result-time">${formatTime(result.timestamp) || '-'}</div>

                        <div class="match-details">
                            ${result.face_score > 0 ? `
                                <div class="match-detail">
                                    <span>üë§ Gesicht:</span>
                                    <span class="value">${result.face_score.toFixed(0)}%</span>
                                </div>
                            ` : ''}
                            ${result.color_score > 0 ? `
                                <div class="match-detail">
                                    <span>üé® Farben:</span>
                                    <span class="value">${result.color_score.toFixed(0)}%</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="result-actions">
                            <button class="btn btn-primary" onclick="openPrintModal('${result.image_id}')">
                                üñ®Ô∏è Drucken
                            </button>
                            <button class="btn btn-secondary" onclick="viewImage('${result.image_id}')">
                                üëÅÔ∏è Ansehen
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Auto-Redirect starten
        startAutoRedirect();
    }
    
    function getMatchClass(score) {
        if (score >= 80) return 'excellent';
        if (score >= 60) return 'good';
        if (score >= 40) return 'fair';
        return 'low';
    }
    
    function showNoResults() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('no-results').style.display = 'block';
        document.getElementById('results-subtitle').textContent = 'Keine Ergebnisse';
    }
    
    // ========================================
    // BILD ANSEHEN MODAL
    // ========================================

    let currentViewImageId = null;

    function viewImage(imageId) {
        currentViewImageId = imageId;

        const modal = document.getElementById('view-modal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        document.getElementById('view-modal-image').src = `/customer/api/image/${imageId}/file?original=true`;
        document.getElementById('view-modal-filename').textContent = 'Bild ansehen';
    }

    function closeViewModal() {
        const modal = document.getElementById('view-modal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        currentViewImageId = null;
    }

    function closeViewModalOnBackground(event) {
        if (event.target.id === 'view-modal') {
            closeViewModal();
        }
    }

    function closePrintModalOnBackground(event) {
        if (event.target.id === 'print-modal') {
            closePrintModal();
        }
    }
    
    // ========================================
    // DRUCK-MODAL
    // ========================================
    
    async function openPrintModal(imageId) {
        try {
            console.log('Opening print modal for image:', imageId);
            printImageId = imageId;
            copies = 1;

            // Drucker-Optionen laden
            console.log('Loading printer options...');
            const data = await api('/customer/api/print/options');
            console.log('Printer options response:', data);
            printerOptions = data.options || [];
            console.log('Parsed printer options:', printerOptions);

            if (!data.enabled) {
                showToast('Drucken ist deaktiviert', 'error');
                return;
            }

            renderPrinterOptions();

            // Vorschaubild
            document.getElementById('print-preview-img').src =
                `/customer/api/image/${imageId}/file?original=true`;

            // Modal √∂ffnen
            const modal = document.getElementById('print-modal');
            modal.classList.add('active');
            modal.style.display = 'flex';  // Fallback
            document.body.style.overflow = 'hidden';

            updateTotal();
            console.log('Print modal opened successfully');

        } catch (error) {
            console.error('Fehler beim √ñffnen des Druck-Modals:', error);
            showToast('Fehler beim √ñffnen des Druck-Modals', 'error');
        }
    }
    
    function renderPrinterOptions() {
        const container = document.getElementById('printer-options');
        
        container.innerHTML = printerOptions.map(printer => `
            <div 
                class="printer-option ${printer.type === selectedPrinter ? 'selected' : ''} ${!printer.enabled ? 'disabled' : ''}"
                onclick="${printer.enabled ? `selectPrinter('${printer.type}')` : ''}"
            >
                <div class="printer-icon">${printer.type === 'small' ? 'üìÑ' : 'üñºÔ∏è'}</div>
                <div class="printer-name">${printer.display_name}</div>
                <div class="printer-size">${printer.paper_size || 'Standard'}</div>
                <div class="printer-price">CHF ${printer.price.toFixed(2)}</div>
            </div>
        `).join('');
    }
    
    function selectPrinter(type) {
        selectedPrinter = type;
        renderPrinterOptions();
        updateTotal();
    }
    
    function changeCopies(delta) {
        copies = Math.max(1, Math.min(10, copies + delta));
        document.getElementById('copies-value').textContent = copies;
        updateTotal();
    }
    
    function updateTotal() {
        const printer = printerOptions.find(p => p.type === selectedPrinter);
        const price = printer ? printer.price : 5;
        const total = price * copies;
        
        document.getElementById('total-amount').textContent = total.toFixed(2);
    }
    
    function closePrintModal() {
        try {
            const modal = document.getElementById('print-modal');
            modal.classList.remove('active');
            modal.style.display = 'none';  // Fallback
            document.body.style.overflow = '';
            printImageId = null;

            // Wenn direkt f√ºr Druck ge√∂ffnet wurde, zur√ºck zur Galerie gehen
            if (isDirectPrint) {
                window.location.href = '/gallery/';
                return;
            }
        } catch (error) {
            console.error('Fehler beim Schlie√üen des Druck-Modals:', error);
            // Fallback: Seite neu laden
            window.location.href = '/customer/';
        }
    }
    
    async function confirmPrint() {
        console.log('confirmPrint called with:', { printImageId, selectedPrinter, copies });

        if (!printImageId) {
            console.error('No printImageId');
            showToast('Kein Bild ausgew√§hlt', 'error');
            return;
        }

        try {
            const requestData = {
                image_id: printImageId,
                printer_type: selectedPrinter,
                copies: copies
            };
            console.log('Sending print request:', requestData);

            const response = await api('/customer/api/print', {
                method: 'POST',
                body: JSON.stringify(requestData)
            });

            console.log('Print response:', response);

            if (response.success) {
                showToast('Druckauftrag gesendet! üñ®Ô∏è', 'success');
                closePrintModal();

                // Nach erfolgreichem Druck zur√ºck zum Karussell
                setTimeout(() => {
                    window.location.href = '/customer/';
                }, 2000); // 2 Sekunden warten f√ºr Toast

            } else {
                showToast(response.error || 'Druckfehler', 'error');
            }

        } catch (error) {
            console.error('Druckfehler:', error);
            showToast('Druckauftrag fehlgeschlagen: ' + error.message, 'error');
        }
    }
    
    // ========================================
    // AUTO-REDIRECT TIMER
    // ========================================

    async function startAutoRedirect() {
        // Timer-Einstellung laden
        try {
            const response = await api('/admin/api/settings/default/search');
            const timerSetting = response.settings?.redirect_timer || 30;

            if (timerSetting > 0) {
                redirectCountdown = timerSetting;
                document.getElementById('countdown').textContent = redirectCountdown;
                document.getElementById('redirect-timer').style.display = 'flex';

                redirectTimer = setInterval(() => {
                    redirectCountdown--;
                    document.getElementById('countdown').textContent = redirectCountdown;

                    if (redirectCountdown <= 0) {
                        clearInterval(redirectTimer);
                        redirectNow();
                    }
                }, 1000);
            }
        } catch (error) {
            console.error('Fehler beim Laden der Redirect-Einstellungen:', error);
        }
    }

    function redirectNow() {
        if (redirectTimer) {
            clearInterval(redirectTimer);
        }
        window.location.href = '/customer/';
    }

    // ========================================
    // NAVIGATION
    // ========================================

    function goBack() {
        window.location.href = '/customer/';
    }
    
    // ========================================
    // INITIALISIERUNG
    // ========================================

    document.addEventListener('DOMContentLoaded', async () => {
        await loadDisplaySettings();
        performSearch();
    });
    
    // ESC zum Schlie√üen des Modals
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closePrintModal();
            closeViewModal();
        }
    });
</script>
{% endblock %}
